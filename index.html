<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Billing Paska UP3 PBN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Select2 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- XLSX CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }
        #login-container {
            width: 300px; margin: 100px auto; border: 2px solid #7faaff; padding: 20px;
            background: #f0f4ff; border-radius: 8px; box-shadow: 0 0 10px #aaa;
        }
        #login-container h3 { text-align: center; color: #003399; margin-bottom: 20px; }
        #login-container label { display: block; margin: 8px 0 4px; }
        #login-container input { width: 100%; padding: 6px; }
        #login-container button {
            margin-top: 10px; width: 100%; padding: 8px;
            background-color: #003399; color: white; border: none; cursor: pointer;
        }
        #data-container { padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid black; }
        th, td { padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .select2-container { width: 100% !important; }
        #zoomModal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); overflow: auto; text-align: center; cursor: grab;
        }
        #zoomModal img {
            margin-top: 5%; max-width: none; max-height: none; transform-origin: center center;
        }
        #zoomModal span {
            position: absolute; top: 10px; right: 20px;
            font-size: 30px; color: white; cursor: pointer;
        }
        #zoomModal button {
            position: absolute; top: 10px; left: 20px;
            z-index: 1001; font-size: 16px; padding: 5px 10px;
            cursor: pointer; background: white; border: none; border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="login-container">
    <h3>ðŸ”Œ DATA PASKA UP3 PBN</h3>
    <label for="username">User ID:</label>
    <input type="text" id="username" placeholder="-ISI USERID-">
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="**********">
    <button onclick="login()">ðŸ”’ Login</button>
</div>

<div id="data-container" style="display: none;">
    <button onclick="logout()">Logout</button>
    <h2>DATA PASKA UP3 PBN</h2>
    <textarea id="inputText" rows="10" cols="50" placeholder="Input format: IDPEL_STATUSDLPD_STATUSLBKB_STANBACA per line"></textarea><br><br>
    <label for="year-input">Masukkan Tahun (BLTH):</label>
    <input type="text" id="year-input" placeholder="Contoh: 202408">
    <button onclick="convertToTable()">Tampil Data</button>
    <button onclick="exportToExcel()">Export to Excel</button>

    <table id="resultTable">
        <thead>
            <tr>
                <th>Keterangan</th>
                <th>IDPEL</th>
                <th>STATUS DLPD</th>
                <th>STATUS LBKB</th>
                <th>STAND BACA</th>
                <th>Stand Verif Input</th>
                <th>PHOTO 1 BLTH KINI</th>
                <th>PHOTO 1 BLTH-1</th>
                <th>PHOTO 1 BLTH-2</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="zoomModal">
    <span onclick="closeZoomModal()">&times;</span>
    <button onclick="resetZoom()">Reset Zoom</button>
    <img id="modalImage">
</div>

<script>
    const keteranganList = [
        "SESUAI", "BURAM STAND TERLIHAT", "BURAM STAND TIDAK TERLIHAT",
        "TIDAK ADA FOTO METER", "SALAH FOTO METER", "KWH METER TINGGI"
    ];

    function login() {
        const u = document.getElementById("username").value;
        const p = document.getElementById("password").value;
        if (u === "UP3PKBUN" && p === "P@ssw0rd") {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("data-container").style.display = "block";
        } else {
            alert("Invalid credentials");
        }
    }

    function logout() {
        document.getElementById("data-container").style.display = "none";
        document.getElementById("login-container").style.display = "block";
    }

    function adjustYearMonth(yearMonth, decrement) {
        let year = parseInt(yearMonth.substring(0, 4));
        let month = parseInt(yearMonth.substring(4, 6));
        month -= decrement;
        while (month <= 0) {
            year -= 1;
            month += 12;
        }
        return `${year}${month.toString().padStart(2, '0')}`;
    }

    function convertToTable() {
        const inputText = document.getElementById('inputText').value;
        const year = document.getElementById('year-input').value.trim();
        const lines = inputText.trim().split('\n');
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';

        lines.forEach((line, idx) => {
            const parts = line.split('_');
            if (parts.length < 4) return;
            const [idpel, statusDLPD, statusLBKB, standBaca] = parts;
            const yearN1 = adjustYearMonth(year, 1);
            const yearN2 = adjustYearMonth(year, 2);

            const selectOptions = keteranganList.map(ket => `<option value="${ket}">${ket}</option>`).join('');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><select class="multi-ket" multiple>${selectOptions}</select></td>
                <td>${idpel.trim()}</td>
                <td>${statusDLPD.trim()}</td>
                <td>${statusLBKB.trim()}</td>
                <td>${standBaca.trim()}</td>
                <td><input type="text"></td>
                <td><img src='https://portalapp.iconpln.co.id/acmt/DisplayBlobServlet1?idpel=${idpel.trim()}&blth=${year}' width='200' height='200' onclick='openZoomModal(this.src)'></td>
                <td><img src='https://portalapp.iconpln.co.id/acmt/DisplayBlobServlet1?idpel=${idpel.trim()}&blth=${yearN1}' width='200' height='200' onclick='openZoomModal(this.src)'></td>
                <td><img src='https://portalapp.iconpln.co.id/acmt/DisplayBlobServlet1?idpel=${idpel.trim()}&blth=${yearN2}' width='200' height='200' onclick='openZoomModal(this.src)'></td>
            `;
            tbody.appendChild(row);
        });

        $('.multi-ket').select2({
            placeholder: "Pilih Keterangan",
            allowClear: true
        });
    }

    function exportToExcel() {
        const table = document.getElementById("resultTable");
        const cloneTable = table.cloneNode(true);
        const tbody = cloneTable.querySelector("tbody");

        tbody.querySelectorAll("tr").forEach((row, i) => {
            const ketCell = row.cells[0];
            const inputCell = row.cells[5];

            const originalRow = table.querySelectorAll("tbody tr")[i];
            const selected = $(originalRow.cells[0]).find('select').val();
            ketCell.textContent = selected && selected.length ? selected.join(", ") : "-";

            const inputVal = $(originalRow.cells[5]).find('input').val();
            inputCell.textContent = inputVal || "-";
        });

        const wb = XLSX.utils.table_to_book(cloneTable, { sheet: "Data Pasca" });
        XLSX.writeFile(wb, "Data_Pasca_UP3_PBN.xlsx");
    }

    // Zoom Modal Logic
    let scale = 1;
    const modal = document.getElementById('zoomModal');
    const modalImg = document.getElementById('modalImage');

    function openZoomModal(src) {
        scale = 1;
        modal.style.display = 'block';
        modalImg.src = src;
        modalImg.style.transform = 'scale(1)';
    }

    function closeZoomModal() {
        modal.style.display = 'none';
    }

    function resetZoom() {
        scale = 1;
        modalImg.style.transform = 'scale(1)';
    }

    modalImg.addEventListener('wheel', function(e) {
        e.preventDefault();
        const zoom = 0.1;
        scale += (e.deltaY < 0 ? zoom : -zoom);
        scale = Math.max(1, scale);
        modalImg.style.transform = `scale(${scale})`;
    });

    let isDragging = false, startX, startY;
    modalImg.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.pageX - modalImg.offsetLeft;
        startY = e.pageY - modalImg.offsetTop;
        modalImg.style.cursor = 'grabbing';
    });

    modal.addEventListener('mouseup', () => {
        isDragging = false;
        modalImg.style.cursor = 'grab';
    });

    modal.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        modal.scrollLeft -= e.movementX;
        modal.scrollTop -= e.movementY;
    });
</script>

</body>
</html>
